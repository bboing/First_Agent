<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>노드 편집기 - RAG 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <style>
        .react-flow-container {
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .node-panel {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .node-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .node-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .flow-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        
        .custom-node {
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #007bff;
            background: white;
            min-width: 150px;
        }
        
        .custom-node.selected {
            border-color: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="/static/logo/taegyun_logo.png" alt="Logo" height="30" class="d-inline-block align-text-top me-2">
                RAG 시스템 - 노드 편집기
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/chat-ui"><i class="fas fa-comments"></i> 챗봇</a>
                <a class="nav-link" href="/RAG_Chat"><i class="fas fa-database"></i> RAG 관리</a>
                <a class="nav-link active" href="/node-editor"><i class="fas fa-project-diagram"></i> 노드 편집</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 text-muted text-uppercase">
                        <span>노드 도구</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="addTextNode()">
                                <i class="fas fa-font"></i> 텍스트 노드
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="addProcessNode()">
                                <i class="fas fa-cogs"></i> 프로세스 노드
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="addDecisionNode()">
                                <i class="fas fa-question-circle"></i> 결정 노드
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="addDataNode()">
                                <i class="fas fa-database"></i> 데이터 노드
                            </a>
                        </li>
                    </ul>

                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 text-muted text-uppercase mt-4">
                        <span>편집 도구</span>
                    </h6>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="clearCanvas()">
                                <i class="fas fa-trash"></i> 캔버스 지우기
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="exportFlow()">
                                <i class="fas fa-download"></i> 내보내기
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="importFlow()">
                                <i class="fas fa-upload"></i> 가져오기
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 ms-sm-auto px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">노드 편집기</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="saveFlow()">
                                <i class="fas fa-save"></i> 저장
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadFlow()">
                                <i class="fas fa-folder-open"></i> 불러오기
                            </button>
                        </div>
                    </div>
                </div>

                <!-- React Flow Container -->
                <div class="react-flow-container" id="react-flow-container">
                    <div class="flow-controls">
                        <button class="btn btn-sm btn-outline-primary" onclick="fitView()">
                            <i class="fas fa-expand"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="zoomIn()">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="zoomOut()">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>

                <!-- Node Properties Panel -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="node-panel">
                            <h6><i class="fas fa-edit"></i> 노드 속성</h6>
                            <div id="node-properties">
                                <p class="text-muted">노드를 선택하면 속성을 편집할 수 있습니다.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="node-panel">
                            <h6><i class="fas fa-info-circle"></i> 플로우 정보</h6>
                            <div id="flow-info">
                                <p><strong>노드 개수:</strong> <span id="node-count">0</span></p>
                                <p><strong>연결 개수:</strong> <span id="edge-count">0</span></p>
                                <p><strong>선택된 노드:</strong> <span id="selected-node">없음</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- React Flow Scripts -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/reactflow@11.10.3/dist/umd/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="text/babel">
        {% raw %}
        const { ReactFlow, Background, Controls, MiniMap, useNodesState, useEdgesState, addEdge } = ReactFlow;

        // 커스텀 노드 컴포넌트
        const CustomNode = ({ data, selected }) => {
            return (
                <div className={`custom-node ${selected ? 'selected' : ''}`}>
                    <div style={{ fontWeight: 'bold', marginBottom: '5px' }}>
                        {data.label}
                    </div>
                    <div style={{ fontSize: '12px', color: '#666' }}>
                        {data.description}
                    </div>
                </div>
            );
        };
        {% endraw %}

        // 메인 컴포넌트
        function NodeEditor() {
            const [nodes, setNodes, onNodesChange] = useNodesState([]);
            const [edges, setEdges, onEdgesChange] = useEdgesState([]);

            const onConnect = useCallback((params) => {
                setEdges((eds) => addEdge(params, eds));
            }, [setEdges]);

            const onNodeClick = useCallback((event, node) => {
                // 노드 선택 시 속성 패널 업데이트
                updateNodeProperties(node);
            }, []);

            const updateNodeProperties = (node) => {
                const propertiesDiv = document.getElementById('node-properties');
                propertiesDiv.innerHTML = `
                    <div class="mb-3">
                        <label class="form-label">노드 라벨</label>
                        <input type="text" class="form-control" value="${node.data.label}" 
                               onchange="updateNodeLabel('${node.id}', this.value)">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">설명</label>
                        <textarea class="form-control" rows="3" 
                                  onchange="updateNodeDescription('${node.id}', this.value)">${node.data.description}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">노드 타입</label>
                        <select class="form-select" onchange="updateNodeType('${node.id}', this.value)">
                            <option value="text" ${node.data.type === 'text' ? 'selected' : ''}>텍스트</option>
                            <option value="process" ${node.data.type === 'process' ? 'selected' : ''}>프로세스</option>
                            <option value="decision" ${node.data.type === 'decision' ? 'selected' : ''}>결정</option>
                            <option value="data" ${node.data.type === 'data' ? 'selected' : ''}>데이터</option>
                        </select>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="deleteNode('${node.id}')">
                        <i class="fas fa-trash"></i> 노드 삭제
                    </button>
                `;
                
                document.getElementById('selected-node').textContent = node.data.label;
            };

            // 전역 함수들
            window.addTextNode = () => {
                const newNode = {
                    id: `node-${Date.now()}`,
                    type: 'custom',
                    position: { x: 100, y: 100 },
                    data: { 
                        label: '새 텍스트 노드', 
                        description: '텍스트 내용을 입력하세요',
                        type: 'text'
                    }
                };
                setNodes((nds) => nds.concat(newNode));
            };

            window.addProcessNode = () => {
                const newNode = {
                    id: `node-${Date.now()}`,
                    type: 'custom',
                    position: { x: 300, y: 100 },
                    data: { 
                        label: '새 프로세스 노드', 
                        description: '처리 과정을 설명하세요',
                        type: 'process'
                    }
                };
                setNodes((nds) => nds.concat(newNode));
            };

            window.addDecisionNode = () => {
                const newNode = {
                    id: `node-${Date.now()}`,
                    type: 'custom',
                    position: { x: 500, y: 100 },
                    data: { 
                        label: '새 결정 노드', 
                        description: '결정 조건을 입력하세요',
                        type: 'decision'
                    }
                };
                setNodes((nds) => nds.concat(newNode));
            };

            window.addDataNode = () => {
                const newNode = {
                    id: `node-${Date.now()}`,
                    type: 'custom',
                    position: { x: 700, y: 100 },
                    data: { 
                        label: '새 데이터 노드', 
                        description: '데이터 정보를 입력하세요',
                        type: 'data'
                    }
                };
                setNodes((nds) => nds.concat(newNode));
            };

            window.clearCanvas = () => {
                if (confirm('모든 노드를 삭제하시겠습니까?')) {
                    setNodes([]);
                    setEdges([]);
                    document.getElementById('node-properties').innerHTML = 
                        '<p class="text-muted">노드를 선택하면 속성을 편집할 수 있습니다.</p>';
                    document.getElementById('selected-node').textContent = '없음';
                }
            };

            window.updateNodeLabel = (nodeId, newLabel) => {
                setNodes((nds) => nds.map((node) => 
                    node.id === nodeId ? { ...node, data: { ...node.data, label: newLabel } } : node
                ));
            };

            window.updateNodeDescription = (nodeId, newDescription) => {
                setNodes((nds) => nds.map((node) => 
                    node.id === nodeId ? { ...node, data: { ...node.data, description: newDescription } } : node
                ));
            };

            window.updateNodeType = (nodeId, newType) => {
                setNodes((nds) => nds.map((node) => 
                    node.id === nodeId ? { ...node, data: { ...node.data, type: newType } } : node
                ));
            };

            window.deleteNode = (nodeId) => {
                if (confirm('이 노드를 삭제하시겠습니까?')) {
                    setNodes((nds) => nds.filter((node) => node.id !== nodeId));
                    setEdges((eds) => eds.filter((edge) => edge.source !== nodeId && edge.target !== nodeId));
                    document.getElementById('node-properties').innerHTML = 
                        '<p class="text-muted">노드를 선택하면 속성을 편집할 수 있습니다.</p>';
                    document.getElementById('selected-node').textContent = '없음';
                }
            };

            window.saveFlow = () => {
                const flowData = { nodes, edges };
                const dataStr = JSON.stringify(flowData);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'flow-data.json';
                link.click();
            };

            window.loadFlow = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const flowData = JSON.parse(event.target.result);
                            setNodes(flowData.nodes || []);
                            setEdges(flowData.edges || []);
                        } catch (error) {
                            alert('파일을 불러오는 중 오류가 발생했습니다.');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            window.exportFlow = () => {
                saveFlow();
            };

            window.importFlow = () => {
                loadFlow();
            };

            window.fitView = () => {
                // React Flow의 fitView 기능
                console.log('Fit view clicked');
            };

            window.zoomIn = () => {
                // React Flow의 zoomIn 기능
                console.log('Zoom in clicked');
            };

            window.zoomOut = () => {
                // React Flow의 zoomOut 기능
                console.log('Zoom out clicked');
            };

            // 노드와 엣지 개수 업데이트
            useEffect(() => {
                document.getElementById('node-count').textContent = nodes.length;
                document.getElementById('edge-count').textContent = edges.length;
            }, [nodes, edges]);

            const nodeTypes = {
                custom: CustomNode
            };

            return (
                <div style={{ width: '100%', height: '600px' }}>
                    <ReactFlow
                        nodes={nodes}
                        edges={edges}
                        onNodesChange={onNodesChange}
                        onEdgesChange={onEdgesChange}
                        onConnect={onConnect}
                        onNodeClick={onNodeClick}
                        nodeTypes={nodeTypes}
                        fitView
                    >
                        <Background />
                        <Controls />
                        <MiniMap />
                    </ReactFlow>
                </div>
            );
        }

        // React 컴포넌트 렌더링
        const root = ReactDOM.createRoot(document.getElementById('react-flow-container'));
        root.render(<NodeEditor />);
    </script>
</body>
</html> 